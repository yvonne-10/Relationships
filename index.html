<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relationship Cards</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#111217; --muted:#9aa3ab; --text:#eaf1f6; --accent:#5ee0a0; --accent-2:#7ab7ff; --danger:#ff6b6b; --ring:0 0 0 3px rgba(122,183,255,.35)
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 20% -10%, #162033 0%, #0d1320 45%, var(--bg) 100%);color:var(--text);font:15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(#0d1320, rgba(13,19,32,.7));backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 18px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    h1{font-size:18px;margin:0 12px 0 0;letter-spacing:.2px}
    button, select, label{color:var(--text)}
    button, select{border:1px solid rgba(255,255,255,.12);background:#0f1423;padding:9px 12px;border-radius:12px;cursor:pointer;transition:.2s ease}
    button:hover{transform:translateY(-1px)}
    button.primary{background:linear-gradient(135deg, var(--accent-2), var(--accent));border:0;color:#0a1020;font-weight:700}
    button.ghost{background:transparent}
    button.danger{background:#221217;border-color:#44252a;color:#ffb3b3}
    select{appearance:none;padding-right:32px;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="white"><path d="M5 7l5 6 5-6z"/></svg>');background-repeat:no-repeat;background-position:right 8px center}

    /* Cards */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;padding:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .title h3{margin:0;font-size:17px}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(122,183,255,.1);border:1px solid rgba(122,183,255,.35);color:#cfe3ff}

    .meta{display:grid;gap:6px;margin:6px 0 10px}
    .meta div{display:flex;gap:8px;align-items:center}
    .meta label{width:120px;color:var(--muted)}
    .impression{color:#d7e2eb;background:#0d1420;border:1px solid rgba(255,255,255,.06);padding:10px;border-radius:12px;min-height:44px}
    .row-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .value-ico{display:flex;align-items:center;gap:6px}

    /* Chips for activities */
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.15);background:rgba(122,183,255,.08);color:#cfe3ff;cursor:pointer;user-select:none}
    .chip.on{background:rgba(94,224,160,.18);border-color:rgba(94,224,160,.5);color:#d6ffe9}

    /* Dialog */
    dialog{border:0;border-radius:18px;max-width:700px;width:96%;padding:0;background:#0f1423;color:var(--text);box-shadow:0 28px 120px rgba(0,0,0,.55)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .dlg-head{padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center}
    .dlg-body{padding:18px}
    form.grid{grid-template-columns:1fr 1fr}
    .full{grid-column:1/-1}
    input, textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0a1020;color:var(--text)}
    input:focus, textarea:focus, select:focus{outline:none;box-shadow:var(--ring)}
    .hint{color:var(--muted);font-size:12px}

    .empty{opacity:.75;text-align:center;padding:32px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:11px;color:#cfe3ff}

    /* Tabs & pages */
    .tabs{display:flex;gap:8px;margin-right:6px}
    .tabs button{border-radius:999px;padding:8px 12px}
    #page-calendar{display:none}

    /* Calendar */
    .cal-wrap{padding:18px}
    .cal-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .calendar{width:100%;border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden}
    .cal-head{display:grid;grid-template-columns:repeat(7,1fr);background:#0e1422;border-bottom:1px solid rgba(255,255,255,.08)}
    .cal-head div{padding:10px 8px;text-align:center;color:#9fb0c6;font-weight:600}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02))}
    .day{min-height:108px;border-right:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06);padding:6px;display:flex;flex-direction:column;gap:6px}
    .day:nth-child(7n){border-right:none}
    .day .num{font-size:12px;color:#a9b8c8}
    .muted{opacity:.45}
    .ev{font-size:12px;border-radius:10px;padding:4px 6px;border:1px solid rgba(255,255,255,.12);overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .ev.bd{background:rgba(255,223,128,.08);color:#ffe29a;border-color:rgba(255,223,128,.3)}
    .ev.mt{background:rgba(126,231,170,.08);color:#9af3c5;border-color:rgba(126,231,170,.28)}

    @media (max-width:600px){form.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1 id="title">Relationship Cards</h1>
      <div class="tabs">
        <button id="tabCards" class="primary">Cards</button>
        <button id="tabCalendar" class="ghost">Calendar</button>
      </div>
      <button id="addBtn" class="primary">Ôºã Add Friend</button>

      <div style="flex:1"></div>

      <label id="sortLabel" for="sort">Sort by</label>
      <select id="sort">
        <option value="added">Recently added</option>
        <option value="upcoming-birthday">Upcoming birthdays</option>
        <option value="not-met">Longest not meeting</option>
        <option value="known">Longest known</option>
        <option value="name">Name A ‚Üí Z</option>
      </select>
      <button id="applySort" class="ghost">Apply</button>

      <label id="langLabel" for="lang">Language</label>
      <select id="lang">
        <option value="en">English</option>
        <option value="zh">‰∏≠Êñá</option>
        <option value="no">Norsk</option>
        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
      </select>
    </div>
  </header>

  <!-- Page: Cards -->
  <main id="page-cards">
    <section class="grid" id="cards"></section>
    <section id="empty" class="empty" hidden>
      <p id="emptyText">No friends yet. Click <span class="pill">Ôºã Add Friend</span> to create your first card.</p>
    </section>
  </main>

  <!-- Page: Calendar -->
  <main id="page-calendar">
    <div class="cal-wrap wrap">
      <div class="cal-controls">
        <label id="monthLabel">Month <input id="monthPicker" type="month"></label>
        <label class="row" style="gap:6px">
          <input type="checkbox" id="toggleBirthdays" checked /> <span id="bdToggleText">Birthdays</span>
        </label>
        <label class="row" style="gap:6px">
          <input type="checkbox" id="toggleMeetings" checked /> <span id="mtToggleText">Meetings</span>
        </label>
      </div>
      <div class="calendar">
        <div class="cal-head" id="calHead"></div>
        <div id="calGrid" class="cal-grid"></div>
      </div>
    </div>
  </main>

  <template id="cardTpl">
    <article class="card">
      <div class="title">
        <h3 class="nm"></h3>
        <span class="badge bdayBadge"></span>
      </div>
      <div class="meta">
        <div><label>üéÇ <span data-k="birthday">Birthday</span></label><span class="bday value-ico"></span></div>
        <div><label>üéâ <span data-k="next_birthday">Next birthday</span></label><span class="nextBday value-ico"></span></div>
        <div><label>üß≠ <span data-k="age">Age</span></label><span class="age value-ico"></span></div>
        <div><label>‚ôí <span data-k="star_sign">Star sign</span></label><span class="starsign value-ico"></span></div>
        <div><label>üêâ <span data-k="zodiac">Chinese zodiac</span></label><span class="czodiac value-ico"></span></div>
        <div><label>üíº <span data-k="career">Career</span></label><span class="career"></span></div>
        <div><label>ü§ù <span data-k="met_on">Met on</span></label><span class="met"></span></div>
        <div><label>‚è≥ <span data-k="known">Known</span></label><span class="known"></span></div>
        <div><label>üìÖ <span data-k="last_met">Last met</span></label><span class="lastmet"></span></div>
        <div><label>üï∞Ô∏è <span data-k="not_met_for">Not met for</span></label><span class="notmet"></span></div>
      </div>
      <div class="impression"></div>
      <div class="row-actions">
        <button class="ghost" data-act="addMeeting">Ôºã <span data-k="meeting">Meeting</span></button>
        <button class="ghost" data-act="edit"><span data-k="edit">Edit</span></button>
        <button class="danger" data-act="delete"><span data-k="delete">Delete</span></button>
      </div>
    </article>
  </template>

  <!-- Add/Edit Friend Dialog -->
  <dialog id="dlg">
    <form id="f" class="grid" method="dialog">
      <div class="dlg-head full">
        <strong id="dlgTitle">Add friend</strong>
        <button type="button" id="closeDlg" class="ghost">‚úï</button>
      </div>
      <div class="dlg-body full">
        <div class="grid">
          <label class="full"><span data-k="name">Name</span>
            <input required name="name" placeholder="e.g., Sam" />
          </label>
          <label><span data-k="birthday">Birthday</span>
            <input required type="date" name="birthday" />
          </label>
          <label><span data-k="met_on_first">Met on (first met)</span>
            <input required type="date" name="metDate" />
          </label>
          <label><span data-k="last_met_opt">Last met (optional)</span>
            <input type="date" name="lastMetDate" />
          </label>
          <label class="full"><span data-k="career">Career</span>
            <input name="career" placeholder="e.g., Designer" />
          </label>
          <label class="full"><span data-k="impression">Impression</span>
            <textarea name="impression" rows="3" placeholder="Your notes‚Ä¶"></textarea>
          </label>
          <p class="hint full" id="hintNotMet">Tip: ‚ÄúLongest not meeting‚Äù uses the most recent of <em>Last met</em> or any logged <em>Meeting</em>.</p>
        </div>
      </div>
      <div class="wrap row full" style="justify-content:flex-end;gap:8px;border-top:1px solid rgba(255,255,255,.08);padding-top:12px">
        <button type="button" id="resetForm" class="ghost"><span data-k="reset">Reset</span></button>
        <button class="primary"><span data-k="save">Save</span></button>
      </div>
    </form>
  </dialog>

  <!-- Add Meeting Dialog -->
  <dialog id="meetDlg">
    <form id="meetForm" class="grid" method="dialog">
      <div class="dlg-head full">
        <strong id="meetTitle">Add meeting</strong>
        <button type="button" id="closeMeetDlg" class="ghost">‚úï</button>
      </div>
      <div class="dlg-body full">
        <div class="grid">
          <label><span data-k="date">Date</span>
            <input required type="date" name="date" />
          </label>
          <label class="full"><span data-k="activities">Activities</span></label>
          <div id="actChips" class="chips full"></div>
          <div class="full row" style="gap:8px;align-items:center">
            <input id="actInput" placeholder="e.g., Dinner, Sports, Coffee" />
            <button id="addAct" type="button" class="ghost">Ôºã <span data-k="add_to_choices">Add to choices</span></button>
          </div>
          <label class="full"><span data-k="note">Note</span>
            <input name="note" placeholder="Optional note (e.g., Sushi at Kazu)" />
          </label>
          <p class="hint full" id="meetFriendName"></p>
        </div>
      </div>
      <div class="wrap row full" style="justify-content:flex-end;gap:8px;border-top:1px solid rgba(255,255,255,.08);padding-top:12px">
        <button class="primary"><span data-k="save">Save</span></button>
      </div>
    </form>
  </dialog>

  <script>
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => [...el.querySelectorAll(s)];

    const storeKey = 'relationship_cards_v1';
    const typeKey = 'relationship_cards_meet_types_v1';
    const langKey = 'relationship_cards_lang';

    const locales = { en:'en', zh:'zh-CN', no:'nb-NO', ko:'ko' };

    // ---- i18n ----
    const i18n = {
      en:{
        app_title:'Relationship Cards', cards:'Cards', calendar:'Calendar', add_friend:'Ôºã Add Friend',
        sort_by:'Sort by', apply:'Apply', language:'Language',
        recently_added:'Recently added', upcoming_birthdays:'Upcoming birthdays', longest_not_meeting:'Longest not meeting', longest_known:'Longest known', name_az:'Name A ‚Üí Z',
        birthday:'Birthday', next_birthday:'Next birthday', age:'Age', star_sign:'Star sign', zodiac:'Chinese zodiac', career:'Career', met_on:'Met on', met_on_first:'Met on (first met)', known:'Known', last_met:'Last met', last_met_opt:'Last met (optional)', not_met_for:'Not met for', impression:'Impression',
        reset:'Reset', save:'Save', edit:'Edit', delete:'Delete', meeting:'Meeting', date:'Date', activities:'Activities', add_to_choices:'Add to choices', note:'Note',
        empty_prefix:'No friends yet. Click', empty_suffix:'to create your first card.',
        month:'Month', birthdays:'Birthdays', meetings:'Meetings',
        days_short:['Sun','Mon','Tue','Wed','Thu','Fri','Sat']
      },
      zh:{
        app_title:'ÂÖ≥Á≥ªÂç°Áâá', cards:'Âç°Áâá', calendar:'Êó•ÂéÜ', add_friend:'Ôºã Ê∑ªÂä†Â•ΩÂèã',
        sort_by:'ÊéíÂ∫è', apply:'Â∫îÁî®', language:'ËØ≠Ë®Ä',
        recently_added:'ÊúÄËøëÊ∑ªÂä†', upcoming_birthdays:'Âç≥Â∞ÜËøáÁîüÊó•', longest_not_meeting:'ÊúÄ‰πÖÊú™ËßÅ', longest_known:'ËÆ§ËØÜÊúÄ‰πÖ', name_az:'ÂßìÂêç A ‚Üí Z',
        birthday:'ÁîüÊó•', next_birthday:'‰∏ãÊ¨°ÁîüÊó•', age:'Âπ¥ÈæÑ', star_sign:'ÊòüÂ∫ß', zodiac:'ÁîüËÇñ', career:'ËÅå‰∏ö', met_on:'ÂàùÊ¨°Áõ∏ËØÜ', met_on_first:'ÂàùÊ¨°Áõ∏ËØÜ', known:'ËÆ§ËØÜÊó∂Èó¥', last_met:'‰∏äÊ¨°ËßÅÈù¢', last_met_opt:'‰∏äÊ¨°ËßÅÈù¢ÔºàÂèØÈÄâÔºâ', not_met_for:'Êú™ËßÅÂ§©Êï∞', impression:'Âç∞Ë±°',
        reset:'ÈáçÁΩÆ', save:'‰øùÂ≠ò', edit:'ÁºñËæë', delete:'Âà†Èô§', meeting:'ËßÅÈù¢', date:'Êó•Êúü', activities:'Ê¥ªÂä®', add_to_choices:'Âä†ÂÖ•Âà∞ÈÄâÈ°π', note:'Â§áÊ≥®',
        empty_prefix:'ÊöÇÊó†Â•ΩÂèãÔºåÁÇπÂáª', empty_suffix:'ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏ÄÂº†Âç°Áâá„ÄÇ',
        month:'Êúà‰ªΩ', birthdays:'ÁîüÊó•', meetings:'ËßÅÈù¢',
        days_short:['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠']
      },
      no:{
        app_title:'Vennekort', cards:'Kort', calendar:'Kalender', add_friend:'Ôºã Legg til venn',
        sort_by:'Sorter etter', apply:'Bruk', language:'Spr√•k',
        recently_added:'Nylig lagt til', upcoming_birthdays:'Kommende bursdager', longest_not_meeting:'Lengst siden vi m√∏ttes', longest_known:'Lengst kjent', name_az:'Navn A ‚Üí √Ö',
        birthday:'Bursdag', next_birthday:'Neste bursdag', age:'Alder', star_sign:'Stjernetegn', zodiac:'Kinesisk dyrekrets', career:'Yrke', met_on:'M√∏ttes', met_on_first:'M√∏ttes (f√∏rste gang)', known:'Kjent i', last_met:'Sist m√∏tt', last_met_opt:'Sist m√∏tt (valgfritt)', not_met_for:'Ikke m√∏tt p√•', impression:'Inntrykk',
        reset:'Nullstill', save:'Lagre', edit:'Rediger', delete:'Slett', meeting:'M√∏te', date:'Dato', activities:'Aktiviteter', add_to_choices:'Legg til i valg', note:'Notat',
        empty_prefix:'Ingen venner enn√•. Klikk', empty_suffix:'for √• lage det f√∏rste kortet.',
        month:'M√•ned', birthdays:'Bursdager', meetings:'M√∏ter',
        days_short:['S√∏n','Man','Tir','Ons','Tor','Fre','L√∏r']
      },
      ko:{
        app_title:'ÏπúÍµ¨ Ïπ¥Îìú', cards:'Ïπ¥Îìú', calendar:'Îã¨Î†•', add_friend:'Ôºã ÏπúÍµ¨ Ï∂îÍ∞Ä',
        sort_by:'Ï†ïÎ†¨ Í∏∞Ï§Ä', apply:'Ï†ÅÏö©', language:'Ïñ∏Ïñ¥',
        recently_added:'ÏµúÍ∑º Ï∂îÍ∞Ä', upcoming_birthdays:'Îã§Í∞ÄÏò§Îäî ÏÉùÏùº', longest_not_meeting:'Í∞ÄÏû• Ïò§Îûò Ïïà ÎßåÎÇ®', longest_known:'Í∞ÄÏû• Ïò§Îûò Ïïé', name_az:'Ïù¥Î¶Ñ A ‚Üí Z',
        birthday:'ÏÉùÏùº', next_birthday:'Îã§Ïùå ÏÉùÏùº', age:'ÎÇòÏù¥', star_sign:'Î≥ÑÏûêÎ¶¨', zodiac:'Îù†', career:'ÏßÅÏóÖ', met_on:'Ï≤´ ÎßåÎÇ®', met_on_first:'Ï≤´ ÎßåÎÇ®', known:'ÏïåÍ≤å Îêú ÏßÄ', last_met:'ÎßàÏßÄÎßâ ÎßåÎÇ®', last_met_opt:'ÎßàÏßÄÎßâ ÎßåÎÇ®(ÏÑ†ÌÉù)', not_met_for:'Ïïà ÎßåÎÇú Í∏∞Í∞Ñ', impression:'Ïù∏ÏÉÅ',
        reset:'Ï¥àÍ∏∞Ìôî', save:'Ï†ÄÏû•', edit:'Ìé∏Ïßë', delete:'ÏÇ≠Ï†ú', meeting:'ÎßåÎÇ®', date:'ÎÇ†Ïßú', activities:'ÌôúÎèô', add_to_choices:'ÏÑ†ÌÉùÏßÄÏóê Ï∂îÍ∞Ä', note:'Î©îÎ™®',
        empty_prefix:'ÏïÑÏßÅ ÏπúÍµ¨Í∞Ä ÏóÜÏäµÎãàÎã§. ÌÅ¥Î¶≠', empty_suffix:'ÏùÑ ÎàåÎü¨ Ï≤´ Ïπ¥ÎìúÎ•º ÎßåÎì§Ïñ¥ Î≥¥ÏÑ∏Ïöî.',
        month:'Ïõî', birthdays:'ÏÉùÏùº', meetings:'ÎßåÎÇ®',
        days_short:['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†']
      }
    };

    let curLang = localStorage.getItem(langKey) || (navigator.language||'en').slice(0,2);
    if(!i18n[curLang]) curLang = 'en';

    const now = () => new Date(); // local time

    // --- local date utils (avoid timezone shift) ---
    function parseYMD(s){ if(!s) return null; const [y,m,d]=s.split('-').map(Number); if(!y||!m||!d) return null; return new Date(y,m-1,d); }
    function fmtDate(d){ if(!d) return '‚Äî'; const dt = (typeof d==='string')? parseYMD(d) : (d instanceof Date? d : new Date(d)); return new Intl.DateTimeFormat(locales[curLang]||undefined,{year:'numeric',month:'short',day:'2-digit'}).format(dt) }
    function yymmLocal(date){ const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,'0'); return `${y}-${m}` }
    function daysBetween(a,b){ const ms=24*3600*1000; return Math.floor((b-a)/ms) }

    // --- text helpers ---
    function renderStaticUI(){
      const d=i18n[curLang];
      document.title=d.app_title; $('#title').textContent=d.app_title;
      $('#tabCards').textContent=d.cards; $('#tabCalendar').textContent=d.calendar; $('#addBtn').textContent=d.add_friend;
      $('#sortLabel').textContent=d.sort_by; $('#applySort').textContent=d.apply; $('#langLabel').textContent=d.language;
      const map={ 'added':'recently_added','upcoming-birthday':'upcoming_birthdays','not-met':'longest_not_meeting','known':'longest_known','name':'name_az' };
      [...$('#sort').options].forEach(opt=>{ opt.textContent=d[map[opt.value]] });
      $('#emptyText').innerHTML = `${d.empty_prefix} <span class="pill">${d.add_friend}</span> ${d.empty_suffix}`;
      $('#monthLabel').childNodes[0].nodeValue = d.month+' ';
      $('#bdToggleText').textContent=d.birthdays; $('#mtToggleText').textContent=d.meetings;
      // weekday header
      const head=$('#calHead'); head.innerHTML=''; (d.days_short||i18n.en.days_short).forEach(w=>{ const el=document.createElement('div'); el.textContent=w; head.appendChild(el) });
      $('#lang').value=curLang;
    }
    function setLang(lang){ if(!i18n[lang]) return; curLang=lang; localStorage.setItem(langKey,lang); document.documentElement.lang=lang; renderStaticUI(); render(); if(getComputedStyle($('#page-calendar')).display!=='none') buildCalendarUI(); }

    // ---- Age & signs ----
    function ageFromBirthday(bday){ const b=parseYMD(bday); if(!b) return null; const t=now(); let age=t.getFullYear()-b.getFullYear(); const m=t.getMonth()-b.getMonth(); if(m<0 || (m===0 && t.getDate()<b.getDate())) age--; return age }
    function westernSign(bday){ const b=parseYMD(bday); if(!b) return {name:'‚Äî',sym:''}; const m=b.getMonth(), d=b.getDate(); const cuts=[{m:0,d:20,s:'Aquarius',sym:'‚ôí'},{m:1,d:19,s:'Pisces',sym:'‚ôì'},{m:2,d:21,s:'Aries',sym:'‚ôà'},{m:3,d:20,s:'Taurus',sym:'‚ôâ'},{m:4,d:21,s:'Gemini',sym:'‚ôä'},{m:5,d:21,s:'Cancer',sym:'‚ôã'},{m:6,d:23,s:'Leo',sym:'‚ôå'},{m:7,d:23,s:'Virgo',sym:'‚ôç'},{m:8,d:23,s:'Libra',sym:'‚ôé'},{m:9,d:23,s:'Scorpio',sym:'‚ôè'},{m:10,d:22,s:'Sagittarius',sym:'‚ôê'},{m:11,d:22,s:'Capricorn',sym:'‚ôë'}]; let sign={name:'Capricorn',sym:'‚ôë'}; for(const c of cuts){ if(m>c.m || (m===c.m && d>=c.d)) sign={name:c.s,sym:c.sym}; } return sign }
    function chineseZodiac(bday){ const b=parseYMD(bday); if(!b) return {name:'‚Äî',emo:''}; const animals=['Rat','Ox','Tiger','Rabbit','Dragon','Snake','Horse','Goat','Monkey','Rooster','Dog','Pig']; const emoji=['üê≠','üêÇ','üêÖ','üêá','üêâ','üêç','üêé','üêê','üêí','üêì','üêï','üêñ']; let idx=(b.getFullYear()-1900)%12; if(idx<0) idx+=12; return {name:animals[idx], emo:emoji[idx]} }

    // Leap-year aware next birthday
    function isLeapYear(y){ return (y%4===0) && (y%100!==0 || y%400===0) }
    function nextBirthdayInfo(bdayStr){ const b=parseYMD(bdayStr); if(!b) return {inDays:null,date:null}; const today=now(); let next=new Date(today.getFullYear(), b.getMonth(), b.getDate()); if(b.getMonth()===1 && b.getDate()===29 && !isLeapYear(today.getFullYear())) next=new Date(today.getFullYear(),1,28); const todayMid=new Date(today.getFullYear(),today.getMonth(),today.getDate()); if(next<todayMid){ const y=today.getFullYear()+1; next = (b.getMonth()===1 && b.getDate()===29 && !isLeapYear(y))? new Date(y,1,28) : new Date(y,b.getMonth(),b.getDate()); } const inDays=daysBetween(todayMid,next); return {inDays,date:next}; }

    function lastInteractionDate(item){ const dates=[]; if(item.metDate) dates.push(parseYMD(item.metDate)); if(item.lastMetDate) dates.push(parseYMD(item.lastMetDate)); (item.meetings||[]).forEach(m=>{ if(m.date) dates.push(parseYMD(m.date)) }); return dates.length? new Date(Math.max(...dates.map(d=>d.getTime()))): null; }

    function humanKnown(from){ const start=parseYMD(from); if(!start) return '‚Äî'; const t=now(); let months=(t.getFullYear()-start.getFullYear())*12 + (t.getMonth()-start.getMonth()); if(t.getDate()<start.getDate()) months -= 1; const years=Math.floor(months/12), m=months%12; return years>0? (m? `${years} yr ${m} mo`:`${years} yr`) : `${m} mo`; }

    // meeting activity chip store
    function load(){ try{ return JSON.parse(localStorage.getItem(storeKey))||[] }catch{ return [] } }
    function save(list){ localStorage.setItem(storeKey, JSON.stringify(list)) }
    function loadTypes(){ try{ const t = JSON.parse(localStorage.getItem(typeKey)); if(Array.isArray(t) && t.length) return t; }catch{} return ['Dinner','Sports'] }
    function saveTypes(arr){ localStorage.setItem(typeKey, JSON.stringify(Array.from(new Set(arr.map(s=>String(s).trim()).filter(Boolean))))) }

    // ---- Render cards ----
    function render(){
      const list = (load()||[]).map(it=>({ ...it, id: it.id || ((crypto&&crypto.randomUUID)? crypto.randomUUID(): (Date.now().toString(36)+Math.random().toString(36).slice(2))), meetings: Array.isArray(it.meetings)? it.meetings: [] }));
      save(list);
      const container = $('#cards'); container.innerHTML=''; $('#empty').hidden = list.length>0;

      const sortVal = $('#sort').value;
      const sorted = [...list].sort((a,b)=>{
        if(sortVal==='added') return (b.createdAt||0)-(a.createdAt||0);
        if(sortVal==='name') return (a.name||'').localeCompare(b.name||'');
        if(sortVal==='known') return (daysBetween(parseYMD(b.metDate), now()) - daysBetween(parseYMD(a.metDate), now())); // longest known first
        if(sortVal==='upcoming-birthday'){ const ad=nextBirthdayInfo(a.birthday).inDays??99999; const bd=nextBirthdayInfo(b.birthday).inDays??99999; return ad-bd; }
        if(sortVal==='not-met'){ const as=lastInteractionDate(a)? daysBetween(lastInteractionDate(a),now()):-1; const bs=lastInteractionDate(b)? daysBetween(lastInteractionDate(b),now()):-1; return bs-as; }
        return 0;
      });

      for(const item of sorted){
        const tpl = $('#cardTpl').content.cloneNode(true);
        $('.nm',tpl).textContent = item.name || '(Unnamed)';

        const nb=nextBirthdayInfo(item.birthday); const badge=$('.bdayBadge',tpl);
        if(nb.inDays===0) badge.textContent='üéÇ Today!'; else if(nb.inDays===1) badge.textContent='üéâ Tomorrow'; else if(nb.inDays!=null) badge.textContent=`üéà in ${nb.inDays} days`; else badge.textContent='üéÇ';

        const age = ageFromBirthday(item.birthday);
        const ws = westernSign(item.birthday);
        const cz = chineseZodiac(item.birthday);

        $('.bday',tpl).innerHTML = `<span>üéÇ</span> ${fmtDate(item.birthday)}`;
        $('.nextBday',tpl).innerHTML = nb.date? `<span>üìÖ</span> ${fmtDate(nb.date)} (${nb.inDays} days)`:'‚Äî';
        $('.age',tpl).innerHTML = age==null? '‚Äî' : `<span>üß≠</span> ${age}`;
        $('.starsign',tpl).innerHTML = ws.name==='‚Äî'? '‚Äî' : `<span>${ws.sym}</span> ${ws.name}`;
        $('.czodiac',tpl).innerHTML = cz.name==='‚Äî'? '‚Äî' : `<span>${cz.emo}</span> ${cz.name}`;

        $('.career',tpl).textContent = item.career||'‚Äî';
        $('.met',tpl).textContent = item.metDate? fmtDate(item.metDate):'‚Äî';
        $('.known',tpl).textContent = humanKnown(item.metDate);
        const last=lastInteractionDate(item); $('.lastmet',tpl).textContent = last? fmtDate(last):'‚Äî';
        const nmDays= last? daysBetween(last, now()): null; $('.notmet',tpl).textContent = nmDays!=null? `${nmDays} days`:'‚Äî';
        $('.impression',tpl).textContent = item.impression||'';

        // localize labels & actions
        $$('.meta label span[data-k]',tpl).forEach(l=>{ const k=l.getAttribute('data-k'); l.textContent=i18n[curLang][k]||i18n.en[k]||l.textContent; });
        $('[data-act="addMeeting"] span',tpl).textContent = i18n[curLang].meeting;
        $('[data-act="edit"] span',tpl).textContent = i18n[curLang].edit;
        $('[data-act="delete"] span',tpl).textContent = i18n[curLang].delete;

        const el=tpl.firstElementChild;
        $('[data-act="delete"]',el).addEventListener('click',()=>{ if(confirm(`${i18n[curLang].delete} ${item.name}?`)){ const updated=load().filter(x=>x.id!==item.id); save(updated); render(); buildCalendarUI(); }});
        $('[data-act="edit"]',el).addEventListener('click',()=> openDialog(item));
        $('[data-act="addMeeting"]',el).addEventListener('click',()=> openMeetingDialog(item));

        container.appendChild(tpl);
      }

      if(getComputedStyle($('#page-calendar')).display!=='none') buildCalendarUI();
    }

    function openDialog(existing){
      const dlg=$('#dlg'); $('#dlgTitle').textContent = existing? i18n[curLang].edit+' friend' : i18n[curLang].add_friend;
      const f=$('#f'); f.reset(); f.dataset.id= existing?.id || '';
      // localize form
      $$('#dlg [data-k]').forEach(el=>{ const k=el.getAttribute('data-k'); el.textContent = i18n[curLang][k]||el.textContent; });
      $('#hintNotMet').innerHTML = `Tip: ‚Äú${i18n[curLang].longest_not_meeting}‚Äù uses the most recent of <em>${i18n[curLang].last_met}</em> or a logged <em>${i18n[curLang].meeting}</em>.`;
      for(const [k,v] of Object.entries(existing||{})){ if(f.elements[k]) f.elements[k].value=v }
      dlg.showModal();
    }

    // Meeting dialog logic
    let meetingTargetId=null; let selectedActs=new Set();

    function renderActChips(){ const wrap=$('#actChips'); wrap.innerHTML=''; const types=loadTypes(); types.forEach(t=>{ const b=document.createElement('span'); b.className='chip'+(selectedActs.has(t)?' on':''); b.textContent=t; b.addEventListener('click',()=>{ if(selectedActs.has(t)) selectedActs.delete(t); else selectedActs.add(t); b.classList.toggle('on');}); wrap.appendChild(b); }); }

    function openMeetingDialog(friend){ meetingTargetId=friend.id; selectedActs=new Set(); $('#meetFriendName').textContent = `${i18n[curLang].meeting} ‚Äî ${friend.name}`; $('#meetForm').reset(); renderActChips(); $('#meetTitle').textContent = i18n[curLang].meeting; $$('#meetDlg [data-k]').forEach(el=>{ const k=el.getAttribute('data-k'); el.textContent=i18n[curLang][k]||el.textContent; }); $('#meetDlg').showModal(); }

    $('#closeMeetDlg').addEventListener('click',()=> $('#meetDlg').close());
    $('#addAct').addEventListener('click',()=>{ const input=$('#actInput'); const raw=input.value.trim(); if(!raw) return; const parts=raw.split(/[ ,;]+/).map(s=>s.trim()).filter(Boolean); const types=loadTypes(); let changed=false; parts.forEach(p=>{ if(!types.includes(p)){ types.push(p); changed=true; } selectedActs.add(p); }); if(changed) saveTypes(types); input.value=''; renderActChips(); });
    $('#actInput').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#addAct').click(); }});

    $('#meetForm').addEventListener('submit',(e)=>{ e.preventDefault(); const fd=new FormData(e.target); const date=fd.get('date'); const note=fd.get('note')||''; if(!date) return; const list=(load()||[]); const idx=list.findIndex(x=>x.id===meetingTargetId); if(idx>-1){ list[idx].meetings=list[idx].meetings||[]; // store raw YYYY-MM-DD to avoid tz issues
      list[idx].meetings.push({ date, activities:Array.from(selectedActs), note }); save(list);} $('#meetDlg').close(); render(); buildCalendarUI(); });

    // --- Calendar helpers ---
    function eventsForMonth(year,month){ const list=(load()||[]); const showBD=$('#toggleBirthdays')?.checked ?? true; const showMT=$('#toggleMeetings')?.checked ?? true; const arr=[]; for(const f of list){ if(showBD && f.birthday){ const b=parseYMD(f.birthday); if(b && b.getMonth()===month){ arr.push({type:'bd', date:b.getDate(), label:`üéÇ ${f.name}`, friendId:f.id}) }} if(showMT){ const allMeet=[...(f.meetings||[])]; if(f.lastMetDate) allMeet.push({date:f.lastMetDate, note:'(last met)'}); allMeet.forEach(m=>{ if(m.date){ const d=parseYMD(m.date); if(d && d.getFullYear()===year && d.getMonth()===month){ const acts=Array.isArray(m.activities)&&m.activities.length? ` ‚Äî ${m.activities.join(', ')}`:''; const note=m.note? ` ‚Äî ${m.note}`:''; arr.push({type:'mt', date:d.getDate(), label:`ü§ù ${f.name}${acts}${note}`, friendId:f.id}) }}}) } } return arr; }

    function buildCalendarUI(){ const cal=$('#calGrid'); if(!cal) return; cal.innerHTML=''; const mp=$('#monthPicker'); const [y,m]=(mp.value? mp.value: yymmLocal(new Date())).split('-').map(Number); const year=y||now().getFullYear(); const month=(m? m-1: now().getMonth()); const first=new Date(year,month,1); const startOffset=first.getDay(); const startDate=new Date(year,month,1-startOffset); for(let i=0;i<42;i++){ const d=new Date(startDate); d.setDate(startDate.getDate()+i); const inMonth=d.getMonth()===month; const cell=document.createElement('div'); cell.className='day'+(inMonth?'':' muted'); const num=document.createElement('div'); num.className='num'; num.textContent=d.getDate(); cell.appendChild(num); if(inMonth){ const todays=eventsForMonth(year,month).filter(ev=>ev.date===d.getDate()); todays.forEach(ev=>{ const p=document.createElement('div'); p.className='ev '+(ev.type==='bd'?'bd':'mt'); p.textContent=ev.label; cell.appendChild(p) }) } cal.appendChild(cell); } }

    // Tabs
    function showPage(which){ $('#page-cards').style.display=which==='cards'? 'block':'none'; $('#page-calendar').style.display=which==='calendar'? 'block':'none'; $('#tabCards').className=which==='cards'? 'primary':'ghost'; $('#tabCalendar').className=which==='calendar'? 'primary':'ghost'; if(which==='calendar') buildCalendarUI(); }
    $('#tabCards').addEventListener('click',()=> showPage('cards'));
    $('#tabCalendar').addEventListener('click',()=> showPage('calendar'));

    // Calendar controls
    const mp=$('#monthPicker'); mp.value=yymmLocal(new Date()); mp.addEventListener('change', buildCalendarUI); $('#toggleBirthdays').addEventListener('change', buildCalendarUI); $('#toggleMeetings').addEventListener('change', buildCalendarUI);

    // Add/Edit dialog events
    $('#addBtn').addEventListener('click',()=>openDialog());
    $('#applySort').addEventListener('click', render); $('#sort').addEventListener('change', render);
    $('#closeDlg').addEventListener('click',()=> $('#dlg').close());
    $('#resetForm').addEventListener('click',()=> $('#f').reset());

    $('#f').addEventListener('submit',(e)=>{
      e.preventDefault(); const fd=new FormData(e.target); const data=Object.fromEntries(fd.entries());
      // store raw YYYY-MM-DD strings (no timezone conversion)
      data.birthday = data.birthday || ''; data.metDate = data.metDate || ''; data.lastMetDate = data.lastMetDate || '';
      const list=(load()||[]);
      if(e.target.dataset.id){ const idx=list.findIndex(x=>x.id===e.target.dataset.id); if(idx>-1) list[idx]={...list[idx], ...data}; }
      else { const id=(crypto&&crypto.randomUUID)? crypto.randomUUID(): (Date.now().toString(36)+Math.random().toString(36).slice(2)); list.push({ id, createdAt:Date.now(), meetings:[], ...data }); }
      save(list); $('#dlg').close(); render(); buildCalendarUI();
    });

    // Lang select
    $('#lang').addEventListener('change', (e)=> setLang(e.target.value));

    // First paint
    renderStaticUI();
    render();
  </script>
</body>
</html>
